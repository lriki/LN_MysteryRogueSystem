ダンジョン攻略の流れ
==========

マップの種類
----------

MRシステムには、以下の3種類のマップがあります。

- 標準システムマップ
- MRタクティクスマップ
- MRセーフティマップ

### 標準システムマップ

ツクール標準と同様のマップです。

### MRタクティクスマップ

いわゆる、一般的なダンジョンマップです。

### MRセーフティマップ

プレイヤー操作やイベントは標準システムマップと同様にできますが、メニュー画面が MRシステムのものとなります。
攻撃やアイテムの使用はできません。


マップを確認する
----------

エディタのマップリストで、 `MR-Land:` から始まるマップを探してみましょう。

その子マップを見てみると、次ようになっています。

- MR-Land:XXXX
  - [Table]
    - Item
    - Enemy
    - Trap
  - [System]
    - ExitMap
  - [Fixed]
    - いろいろ...
  - [Event]
    - いろいろ...

[Table], [Fixed] など [] で囲まれた名前のマップは、フォルダのようなものであると考えてください。
それぞれ次のような意味があります。

### MR-Land:XXXX

`MR-Land:` から始まるマップを `ランド定義マップ` と呼びます。

### [Table]

アイテムやモンスターの出現テーブルです。この子マップは、X座標をフロア数とみなしてイベントを並べることで、どのフロアにどのエンティティが出現するのか設定することができます。
Item, Enemy, Trap は、それぞれ アイテム、モンスター、罠の出現テーブルです。

### [System]

MRシステムとして重要な意味を持つマップです。
ExitMap は、何らかの理由でプレイヤーがダンジョンから離脱するときの遷移先となるマップです。(クリアした、敵に倒された、など様々)

ここに自動実行イベントを作成すると、ダンジョンから離脱した時のイベントを実行できます。

### [Fixed]

ボス部屋やシャッフルダンジョンなど、事前に形の決まったマップを作成するときは、このマップの子マップとして作成します。

### [Event]

ボス戦後のイベントなど、このランドに近い場所に作っておきたい標準システムマップの置き場所です。
[Event] の子マップは常に標準システムマップとなります。


攻略の流れ
----------

ダンジョン突入からクリアまでの

### ランド定義マップを確認する

ランド定義マップはX座標をフロア番号とみなして設定を行うマップです。

次のイベントが必ず必要です。

- フロア設定用イベント
- 出口(階段)のスポナーイベント

### ランドに入る

ランドに入るには、[場所移動] イベントを使って `MR-Land:` から始まるマップの、座標 (1,0) へ移動します。

ダンジョンの形状や外観(タイルマップなど) は、フロア設定用イベント に従って構築されます。

また出現するアイテムやモンスターは、出現テーブルマップの、現在のフロアに対応する X 座標に存在するスポナーイベントから選択されます。

### フロアを移動する

出口で [進む] アクションを実行すると、 `MR-Prefab` にある階段イベントの実行内容が起動します。

この実行内容にはプラグインコマンドの `MR-ProceedFloorForward` が含まれています。これが実行されると、次のフロアに進みます。

ところで、なぜランドから遠く離れた MR-Prefab マップのイベントが実行されるのでしょうか？

まずはランド定義マップにある階段のスポナーイベントを見てみましょう。

`kObject_ExitPoint_A` という文字列があります。これは、 `MR-Key` が `kObject_ExitPoint_A` であるエンティティを、階段として出現させることを意味します。

`kObject_ExitPoint_A` はデータベースの [アイテム] で定義されています。

このアイテムのメモ欄を見てみると、 `<MR-Prefab: kPrefab_ExitPoint_A>` という設定があります。

これはエンティティがマップ上に出現した時、その見た目には `kPrefab_ExitPoint_A` という名前のイベント(プレハブ)を使うことを意味します。

`kPrefab_ExitPoint_A` は、 `MR-Prefab` マップで定義されています。

このようにエンティティとプレハブは互いに重要な関係を持ちます。

### ランドを出る

最後のフロアで階段を下りたり、途中で倒されたりした場合、今のランドの中にある `ExitMap` という名前のマップへ自動的に移動します。

このマップに自動実行イベントを配置することで、ダンジョンクリア時や、ゲームオーバー時のイベントを実行することができます。

`ExitMap` へ移動した原因を知るには、 `MR-ExitResultDetail` または `MR-ExitResult` という変数の値を確認します。

`MR-ExitResultDetail` は次のような値が格納されます。

- 200: ゴールに到達した。
- 300: 脱出の巻物などによって冒険を中断した。
- 400: ゲームオーバーによって Land から出された。
- 401: 冒険をあきらめた。

おおよそ次のように分類されます。

- 2xx 番: 攻略成功
- 3xx 番: 冒険中断。ペナルティ無し。
- 4xx 番: 冒険失敗。ペナルティ有り。(持ち物を失う等)

`MR-ExitResult` はこれらの値を 100 で割った値が格納されます。実際にはこちらの方が使うことが多いかもしれません。


まとめ
----------

- ダンジョンは `ランド` と呼ばれます。
- `ランド` を作るには `ランド定義マップ` を設定します。 `ランド定義マップ` は名前の先頭が `MR-Land:` となっているマップです。
- `ランド` に入るには、[場所移動] イベントを使って `ランド定義マップ` の座標 (1,0) へ移動します。
- フロアの移動にはプラグインコマンド `MR-ProceedFloorForward` を使います。
- イベント実行内容は `プレハブ` が持っています。
- 何らかの理由で `ランド` から出た場合、 `ExitMap` へ自動的に遷移します。ここに自動実行イベントを配置することで、出た後の処理をコントロールできます。



