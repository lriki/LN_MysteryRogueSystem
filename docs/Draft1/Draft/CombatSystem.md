CombatSystem
==========

「攻撃(武器を振る)」と「ダメージ適用」は別のコマンドとする。

> e.g) シレン2-ケンゴウの刀
> 攻撃したときに一定確率で、通常攻撃するのか特殊能力発動になるのか変わるケースがある。


EffectContext
----------

> 以前の DamageContext(攻撃用), MagicContext(魔法弾用) などを統合したもの。コアスクリプトの Game_Action みたいな感じ。

与ダメージや回復、状態異常の付加など、パラメータ変動を適用するために必要なあらゆる情報を収集し、修正値を作り上げるしくみ。

EffectContext 自身が Entity の Sequel を起動したり、座標を動かしたりすることは無い。
というより、今のところ EffectContext が Command を発行する予定はない。

一連の攻撃に関係する Entity の収集も行い、結果をそれぞれにフィードバックすることも行う。
攻撃側に経験値を与えたり、金銭のやりとりの処理など、Enitty として表現できないいわゆる「報酬」の受け渡しにも利用する。

一度の行動の中で複数の攻撃が発生することも考えられるため、EffectContext は唯一のインスタンスとはしない。
代表的なものだと、連鎖的な罠の発動やカウンター攻撃。


攻撃の流れ
----------

- Dialog からは [武器を振るAction] を、actor=Unit, reactor=装備武器 で post する。
- actor の onAction で行うことは特に無し。
- reactor の onReaction で、目の前の Block へ [効果適用Action] を post する。
    - reactor は Block 内から検索した Unit.
    - actor は、効果を与える、という視点だと Unit でも武器でも構わない。ただ参照方向は Unit -> 武器 なので、actor を 武器 とすると、それを振っている人を求めることができない。

矢や魔法弾も同じような仕組み。攻撃側の Behavior で相手に対して直接ダメージ適用することはなく、
1. EffectContext を作る
2. 効果適用Action に乗せて目の前の Block へ post
3. 相手側で受け取ってヒット判定・ダメージ適用
4. 結果を feedback 通じて攻撃側へ返す


ステート (状態異常・状態変化)
----------

Attribute - Behavior のペアとして実装する。


Note: 攻撃に関係する要素
----------

- 武器攻撃力
- Unit基本攻撃力
- ちから
- 防具防御力
- Unit基本防御力
- 各種特攻
- 状態変化 (buff/debuff)
- 属性
    - 火炎
    - 爆発
    - 武器錆び
    - 盾錆び
- 固定修正値 (ちからの草 印)
- 防御側状態異常 (武器のバクスイ印)
- 環境効果 (10ダメージの土偶)

- ドレイン (回復の剣)
- ダメージ反射 (バトルカウンター)
- 属性耐性
    - 錆び避け (武器)
    - 錆び避け (盾)
- 攻撃側状態異常 (盾のバクスイ印)
- 状態異常・変化耐性



ちからダウンや装備の錆びもパラメータ操作と考え、EffectContext で処理した方がいいかも。

以下は Behavior 側でカバーするべきかも。
- 3方向攻撃
- 前方2マス、3マス攻撃





[2020/11/9] Note: 戦闘不能時の処理
----------

原因：
- HP0
    - 戦闘ダメージ
    - 罠ダメージ
- 冒険をあきらめる
- 即死効果

処理：
- CollapseSequel
- 特殊能力
    - 倒されたときに罠を設置する
    - 倒されたときに周囲の Unit を眠らせる
- ゲームオーバー → 拠点へ
- 退場
    - UniqueEntity が倒れたとき
- 消滅

### 「戦闘不能」ステートについて

HP0 の状態をステートとして表すもの。
ツクール同様、特殊扱いされるステートなので注意。

扱いとしては「別のパラメータやステートに応じて自動付加されるステート」にしてみる。
ツクールでは Game_Battler.refresh を色々なタイミングで呼んで、ここで hp 0 なら戦闘不能ステートをつけているが、こんな感じで、
Step 終了時などに Entity に対して State Refresh をかける。

HP だけではなく、満腹度でも戦闘不能扱いしたりする。
あるいは何らかのパラメータが一定値以上になったら自動的にステートを付加するような拡張も考えられる。

State Refresh からのステート付加は、Effect 適用と同じ流れにしてみる。


