Scheduler
==========

Scheduler クラスが Unit の行動順を決定する。

勢力3つ、行動速度3レベル、計 9 Unit 存在しているときの最も基本的な行動順テーブルは次の通り。
まず 1 を行方向に実行、次に 2 列目を実行… という具合に行動順を振る。(x2 は倍速の意味)

| Unit      | 1 | 2 | 3 |
| ----------|---|---|---|
| Player x1 | x |   |   |
| Player x2 | x | x |   |
| Player x3 | x | x | x |
| Friend x1 |   |   | x |
| Friend x2 | x | x |   |
| Friend x3 | x | x | x |
| Enemy  x1 |   |   | x |
| Enemy  x2 | x | x |   |
| Enemy  x3 | x | x | x |

- "Player" はすべての操作可能キャラを含む。のりうつり、仲間操作などもこれに該当する。

この列1つのことを "Run" と呼ぶ。1つの "Turn" は複数の "Run" から成り立っている。
マップ上のすべての Unit が通常速度であれば、その Turn の Run は1つしかできない。

| Unit      | 1 |
| ----------|---|
| Player x1 | x |
| Enemy1 x1 | x |
| Enemy2 x1 | x |


実行中の速度変化にと割り込みについて
----------
すばやさ草を飲んだり、倍速の杖の効果を得た場合は、現在の Run 内で未行動かつ同一 速度 の終端に Unit を追加する。

ターン開始時:

| Unit      | 1 | Act |
| ----------|---|-----|
| Player x1 | x |     |
| Enemy1 x1 | x |     |
| Enemy2 x1 | x |     |
| Enemy3 x1 | x |     |

ケース例A:

| Unit      | 1 | Act |
| ----------|---|-----|
| Player x1 | x | A. Player がすばやさ草を飲んだら、 |
| Player x2 | x | A. この行が追加される。 |
| Enemy1 x1 | x |   |
| Enemy2 x1 | x | B. Enemy2 が Enemy1 へ倍速の杖を振ったら、 |
| Enemy1 x2 | x | B. この行が追加される。 |
| Enemy3 x1 | x |   |

ケース例B:

| Unit      | 1 | 2 | Act |
| ----------|---|---|---|
| Player x1 | x | x | A. Player がすばやさ草を飲んだら、 |
| Enemy1 x2 | x | x |   |
| Enemy2 x2 | x | x |   |
| Player x2 | x |   | A. この行が追加される。B. さらに Player がすばやさ草を飲んだら、 |
| Player x3 | x |   | A. この行が追加される。 |

行動準テーブルを作るとき、最低行動回数は 1 と考えてテーブルを作る。つまり、この時点では鈍足状態は考慮しない。

テーブルを作り終わり Turn を回し始める最初に、Unit の速度の数だけ "行動トークン" を各 Unit に配る。
その後テーブルに基づいて手番が回ってきたとき、行動トークン をひとつ消費して行動をとる。

もし 行動トークン を持ていなければ行動せずスキップする。

鈍足状態では、この最初に配られるトークンが 2 ターンに 1 回となる。

行動トークンは、速度の上下が発生したタイミングでも増えたり減ったりする。

### 1ターン中に速度の上下が繰り返される場合

| Unit      | 1 | Act |
| ----------|---|---|
| Player x1 | x | A. Player が Enemy1 へ鈍足の杖を振ったら、Enemy1 は行動トークンを1つ失う |
| Enemy1 x1 | x | B. 行動トークンが無いのでスキップ |
| Enemy2 x1 | x | C. Enemy2 が Enemy1 へ倍速の杖を振ったら、 |
| Enemy1 x2 | x | C. この行が追加される。行動トークンもひとつ増える。 |


AI 倍速行動の連続化 (Run 間マージ)
----------

| Unit      | 1 | 2 | 3 |
| ----------|---|---|---|
| Player x1 | x |   |   |
| Enemy  x1 |   |   | x |
| Enemy  x2 | x | x |   |
| Enemy  x3 | x | x | x |

上の表のようなテーブルが作られた場合、AI については

- Player の行動が無い Run で行動予定
- 左側の Run に行動予定がある

この場合、次のように、左側の Run に行動予定をマージする。

| Unit      | 1   | 2 | 3 |
| ----------|-----|---|---|
| Player x1 | x   |   |   |
| Enemy  x1 |     |   | x |
| Enemy  x2 | xx  |   |   |
| Enemy  x3 | xxx |   |   |

Player が倍速の時は次のようになる。

| Unit      | 1 | 2  | 3 |
| ----------|---|----|---|
| Player x2 | x | x  |   |
| Enemy  x1 |   |    | x |
| Enemy  x2 | x | x  |   |
| Enemy  x3 | x | xx |   |

> e.g) シレン2-ダイレップウ
> - 攻撃するときはまとめて3回攻撃。
>   - シレンの隣に2体ダイレップウがいるときも、交互ではなくまとめて攻撃3回、を2体分。
> - x2速シレンとは 1 -> 2 回にわかれる。
> - x3速シレンとは１回ずつ交互に。
> - x2速シレンを追うときは、シレン移動->敵移動->敵攻撃



Run 内の処理
----------

1 つの Run 内では次の処理が順に行われる。

1. マニュアル行動
2. AIマイナーアクション
3. AIメジャーアクション

> [2020/9/27] 従来はこれらは Command によって通知していたが、フレームワークと強く結合したイベントであるし、
> あまり Command の種類を増やしたくもないのでいったん普通のメソッドコールにしてみる。

### マニュアル行動

Run 内の マニュアル行動可能な Unit に対して、マニュアル行動を通知する。

Player など、マニュアル行動可能なものはキー入力等に基づいて行動し、行動トークンを消費する。


### AIマイナーアクション

Run 内の未行動 Unit に対して、AIマイナーアクションを通知する。

仲間や Enemy はここで「移動」を行うことができる。その場合、行動トークンを消費する。

> e.g) シレン2-聖城の巻物 による床アイテムの移動や、ドスコーイ系による階段の移動等もこのフェーズで行われる。

このフェーズでは、基本的に並列 Sequel で結果を示せる行動のみ起こせるようにするべき。そうしないと、ゲームテンポが著しく悪化する。


### AIメジャーアクション

Run 内の未行動 Unit に対して、AIメジャーアクションを通知する。

攻撃など、マイナーアクション以外の行動を起こすフェーズだが、マイナーアクションを行うこともできる。

※例えば、周囲にキャラがたくさんいてマイナーで移動はできなかったが、他の Unit のメジャーによってキャラがいなくなったため、移動できるようになったとき、など。


行動トークンの消費タイミング
----------

Scheduler 側や Command 送信側で消費する。Command 実行側では消費せず、「消費に値する行動をとったか」だけ返す。

> e.g) シレン2-ひまガッパに武器を装備させられたとき
> 「装備する」という Action は、メニューから実行したときは行動を消費するが、カッパが投げてきたアイテムを装備してしまったときは行動を消費しない。
> 行動消費有無で Action を分けるのもありだが、「装備する」の中には呪いや共鳴の処理など非常に多くの要素が入っているので、出来れば共通化したいところ。

> e.g) シレン2-ゲイズ系に操られたとき
> この場合は常に行動を消費する。例えば「メニューからの矢の装備」はターンを消費しないが、操られたときは消費してしまう。
> 操られBehavior の中で常に行動を消費するように実装する必要がある。

操られて行動を消費したときは、「行動トークンの借金」が発生することがある。
この場合、次のターンは行動回数が減る。等倍速であれば行動がスキップされることになる。


行動回数と攻撃回数が異なる Unit について
----------

次のような能力を持った Enemy に対応する。

- x1 速 2 回攻撃
- x2 速 1 回攻撃

### x1 速 2 回攻撃

こちらは単純で、1回のメジャーアクション内で攻撃 Command を2回発行するだけでよい。

### x2 速 1 回攻撃

Scheduler としては普通の x2 速と同様に扱う。

Unit 側で攻撃可能回数を覚えておき、Turn 開始時にリセットすることで対応する。

> 以前は Scheduler 側で Major をスキップするような仕組みを考えたが、Major の中で 移動することもあり得るため、Scheduler 側でカバーすることはできない。
