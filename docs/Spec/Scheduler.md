Scheduler
==========

 Unit の行動順をコントロールする。

最も基本的な行動準テーブルは次の通り。まず 1 を行方向に実行、次に 2 列目を実行… という具合に行動順を振る。(x2 は倍速の意味)

| Unit      | 1 | 2 | 3 |
| ----------|---|---|---|
| Player x1 | x |   |   |
| Player x2 | x | x |   |
| Player x3 | x | x | x |
| Friend x1 |   |   | x |
| Friend x2 | x | x |   |
| Friend x3 | x | x | x |
| Enemy  x1 |   |   | x |
| Enemy  x2 | x | x |   |
| Enemy  x3 | x | x | x |

- "Player" はすべての操作可能キャラを含む。のりうつり、肉、仲間操作などはこれに該当する。

この列1つのことを "Run" と呼ぶ。1つの "Turn" は複数の "Run" から成り立っている。
マップ上のすべての Unit が通常速度であれば、その Turn の Run は1つしかできない。

| Unit      | 1 |
| ----------|---|
| Player x1 | x |
| Enemy1 x1 | x |
| Enemy2 x1 | x |

実行中の速度変化について
----------
すばやさ草を飲んだり、倍速の杖の効果を得た場合は、現在の Run の終端に Unit を追加する。

| Unit      | 1 | 2 | Act |
| ----------|---|---|---|
| Player x2 | x | x | A. Player がすばやさ草を飲んだら、 |
| Enemy1 x1 |   | x |   |
| Enemy2 x1 |   | x | B. Enemy2 が Enemy1 へ倍速の杖を振ったら、 |
| Player x3 | x |   | A. この行が追加される |
| Enemy1 x2 |   | x | B. この行が追加される |

※ Run 自体を 1 と 2 の間に新たに作ってもよいが、現在の Run に追加する方が実装がシンプルになるのでこの方法にしている。

行動準テーブルを作るとき、最低行動回数は 1 と考えてテーブルを作る。つまり、この時点では鈍足状態は考慮しない。

テーブルを作り終わり Turn を回し始める最初に、Unit の速度の数だけ "行動トークン" を各 Unit に配る。
その後テーブルに基づいて手番が回ってきたとき、行動トークン をひとつ消費して行動をとる。
もし 行動トークン を持ていなければ行動せずスキップする。

鈍足状態では、この最初に配られるトークンが 2 ターンに 1 回となる。

行動トークンは他にも、速度の上下が発生したタイミングで増えたり減ったりする。

### 1ターン中に速度の上下が繰り返される場合

| Unit      | 1 | Act |
| ----------|---|---|
| Player x1 | x | A. Player が Enemy1 へ鈍足の杖を振ったら、Enemy1 は行動トークンを1つ失う |
| Enemy1 x1 | x | B. 行動トークンが無いのでスキップ |
| Enemy2 x1 | x | C. Enemy2 が Enemy1 へ倍速の杖を振ったら、 |
| Enemy1 x2 | x | C. この行が追加される。行動トークンもひとつ増える。 |
