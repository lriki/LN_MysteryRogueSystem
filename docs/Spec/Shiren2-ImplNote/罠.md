実装設計-ワナ
==========

GB2 からは投げて当てることでも効果発動。

リスト
----------

### イガイガボトボト

### 一方通行

### 大型地雷

### 落とし穴

### 回転板

### 木の矢のワナ

### ケロケロの雨

### ころび石

### 召喚スイッチ

### 地雷

### 水てきポットン

### 装備はずしのワナ

### 大こうずいのワナ

### 大落石のワナ

### 鉄の矢のワナ

### デロデロの湯

### 毒矢のワナ

### トラバサミ
移動以外の Block 移動で解除される「トラバサミ状態」にする。

以下の考察ではトラバサミEntity側から制限をかけるようなのを考えていたが、リサーチ状況から考えると状態異常扱いするのが無難かも。
トラバサミの Visual アニメーションだけ、トラバサミ状態Behaviorが、足元にトラバサミがあれば一時的に非表示にする、といった対策だけとればひとまずOK。




↓リサーチ

http://asuka.lsx3.com/?%A5%EF%A5%CA%2Fcomment%2F%A5%C8%A5%E9%A5%D0%A5%B5%A5%DF
効果が消えてから実際に Entity の破棄を行うのか？
状態異常として扱うのか？

http://twist.jpn.org/sfcsiren/index.php?%E3%83%88%E3%83%A9%E3%83%90%E3%82%B5%E3%83%9F
対モンスター効果がかなり謎…。
- ふきとばしの杖や場所替えの杖、ワープなどで無理矢理移動させても、動けない状態は解除されない
- 移動させた際に他の罠を踏ませても、発動しない
- やみふくろうや一部のNPCは永久トラバサミ状態になっている (場所替えの杖で移動させても罠にかからないのはそのため)
SFCシレンではトラバサミは状態異常ぽい。

https://seesaawiki.jp/w/shiren5/d/%CD%D1%B8%EC%BD%B8
永久トラバサミ状態にする「はりつけの巻物」というアイテムがある。


**以下、没**

トラバサミはドンムブのような状態異常ではなく、トラバサミの Entity が、上に乗っている Entity の「歩行による Block からの離脱」を禁止する仕組みで動く。
シレン2ではトラバサミの Visual 自体がアニメーションしたりするので、この表現のためにもこのような仕組みが必要となる。

#### フックの仕組みで実装する場合

- 起動したとき、上にいる Entity に対して、フックオブジェクトを Attach する。
- ターゲットの onPreAction のタイミングをフックして、Consumed 返す。
- 数ターン経過したら Detach する。
- 高とび草、丸太、ふきとばしなどでも Detach する。

Detach のタイミングが多岐にわたるため、それを網羅するのが大変。
相手側に状態を持たせることになるので、ライフサイクルを考えるのが負担。
「Blockから離れた」といった Command があれば少しは楽だが…。

#### Block を Entity 化して「Blockから離れた」を実装する場合

- 従来ひとつの Command で実装していた「移動」を、「Block から離れる」「Block へ入る」の2段構えにしてみる。
- Block を Entity 化する。
- Block 内の Entity(地形、アイテム、ワナ等) を Block の関係Entity として扱い、Block への Command をそれぞれにも流すようにする。
- Unit 移動時、reactor としての onPreReaction






### 鈍足のワナ

### 眠りガス

### バネ

### 丸太のワナ

### モンスターのワナ

### 落石のワナ

### レンサのワナ

> トラバサミ問題が解決したので、状態を持つ罠は存在しなくなった。
> こうすると、隣のワナの Behavior を借りてくるかコピーするだけで、罠の効果を発動することができる。
>
> 逆に言うと、今後もし状態を持つような罠の拡張を考えるときはレンサのワナの対象外とするか、
> Attribute も一時的にコピーするような仕組みが必要となる。
