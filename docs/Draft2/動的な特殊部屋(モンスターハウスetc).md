動的な特殊部屋(モンスターハウスetc)
==========


モンスターハウス
----------
http://shiren2.lsx3.com/?%A5%E2%A5%F3%A5%B9%A5%BF%A1%BC%A5%CF%A5%A6%A5%B9
モンスターハウスにドスコーイ系が入ってシコを踏むと、モンスターが部屋の外に出てしまいモンスターハウスが勝手に開始されることもある。

MHコールのタイミングはフェーズによって異なるので注意。
- 歩行フェーズでは発生しない。
    - プレイヤー・仲間・敵すべての移動が終わった後にコール
    - ワナ発動フェーズの前。
- モンスターハウスに投げ入れられたときは、投げた敵の手番の中でコール
    - 検証中だが、少なくとも次の敵に手番が回る前。

この部屋への侵入判定は店でも同様であるため、共通化しておきたいところ。

locate のタイミングで「移動があった」フラグを立てておき、Phase 側から特定のタイミングで清算を行う仕組みにしたほうがよさそう。


店
----------

二択屋
----------
https://seesaawiki.jp/w/shiren5/d/%C3%CF%B2%BC%C5%B9

隠し部屋・隠し通路
----------

攻撃したりあかりの巻物を読むと見つけることができる。


移動床・崩壊床
----------

水移動・壁伸縮
----------
https://seesaawiki.jp/shiren_4/d/%BB%C5%B3%DD%A4%B1%A4%C8%C3%CF%B7%C1%CA%D1%B2%BD



その他適当なアイデア
----------

- プラント : ターン経過で草が生える
- 時間制限付き宝物庫 : トルネコの宝物庫 + 時間切れで部屋消滅・ワープ


Entity とするべきか
----------

モンスターハウスや店だけなら良いかもしれないが、いろいろ拡張の可能性を考え出すと過度に system に組み込むのは避けたいところ。

もし Entity にしたとき、部屋のマージに耐えられるか心配だけど…。

部屋のマージというのは、片方の部屋情報を削除してもう片方へ統合すること。
部屋情報とEntityが独立していると、マージ結果をEntityに通知して、そちらでも情報の合わせこみが必要なので少し複雑になりそう。

### 範囲情報

店等の範囲は、本質的には部屋の範囲とは独立しているべきな気がする。
トルネコの店や宝物庫は、必ずしも部屋の矩形と一致しない。

基本は特殊地形側で矩形を持てるようにするが、「部屋と一致させる」みたいなオプションと共に運用するのがよさそう。

そうすると Room = Area ではなくなる。

また elona のようなオープンなマップ内の一部に店を出現させる場合もやはり、Room = Area ではなくなる。


### 監視者

- モンスターハウスの侵入判定
- お店のセキュリティシステム
- ボスキャラの制覇監視
- 風・地震

ボスキャラの制覇監視は重要で、ボスが想定外の方法で消滅した場合に「マップから消えた」ことをキーとしてイベントを進行させるもの。
ボスの Entity 側からイベント進行させようとすると詰みになる可能性が高くなる。 http://shiren2.lsx3.com/?%BE%AE%A5%CD%A5%BF#m5b6522f


